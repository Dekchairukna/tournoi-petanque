{% import 'macros.html' as macros %}
{% extends 'base.html' %}

{% block title %}
{% if selected_round %}ครั้งที่ {{ selected_round }}{% else %}ทุกคู่แข่งขัน{% endif %} - {{ event.name }}
{% endblock %}

{% block content %}
<div class="container my-4">
  {% if event.logo_list %}
  {% for logo in event.logo_list %}
  <img src="{{ url_for('static', filename='logos/' + logo) }}" alt="โลโก้ของ {{ event.name }}"
    style="max-height: 100px; margin-right: 10px;">
  {% endfor %}
  {% endif %}
  <h2 class="mb-3">{{ event.name }}</h2>
  <h4 class="mb-4">ณ {{ event.location }} | ประเภท {{ event.category }} | รุ่น {{ event.age_group }} |
    {% if selected_round %} ครั้งที่ {{ selected_round }} {% else %} ทุกคู่แข่งขัน {% endif %}
  </h4>

  <!-- ปุ่มเข้าสู่รอบการแข่งขัน -->
<div class="mb-4">
  <h4>เข้าสู่การแข่งขัน</h4>

  <!-- ปุ่มเข้าสู่รอบการแข่งขัน (ในแถวเดียวกัน) -->
<div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
  <!-- ปุ่มรอบต่าง ๆ ด้านซ้าย -->
  <div class="d-flex flex-wrap align-items-center">
    {% for round_num in range(1, event.rounds + 1) %}
    <a href="{{ url_for('round_matches', event_id=event.id, round=round_num) }}"
      class="btn btn-outline-dark mb-2 me-2 {% if round_num == current_round %}fw-bold{% endif %}">
      ครั้งที่ {{ round_num }}
    </a>
    {% endfor %}
  </div>

  <!-- ปุ่มดูตารางประกบคู่ ด้านขวา -->
  <div class="mb-2">
    <a href="{{ url_for('match_pairs', event_id=event.id, round=selected_round) }}"
      class="btn btn-info">ดูตารางประกบคู่</a>
  </div>
</div>

</div>



  <!-- FORM กรอกผลการแข่งขัน -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-info text-white fw-semibold fs-5">
      ฟอร์มกรอกผลการแข่งขัน
    </div>
    <div class="card-body p-3">
      {% if error_message %}
      <div class="alert alert-warning">{{ error_message }}</div>
      {% endif %}

      {% if current_user.is_authenticated and current_user.role in ['admin', 'superadmin'] %}
      <form method="POST">
        <!-- ส่วนอื่นๆ ของฟอร์ม -->

        <div class="mb-3">
          <label for="fieldStart" class="form-label">เริ่มที่สนามหมายเลข</label>
          <input type="number" class="form-control" id="fieldStart" name="field_start" value="{{ field_start or '' }}"
            min="1">
        </div>

        <div class="mb-3">
          <label for="fieldExclude" class="form-label">สนามที่ยกเว้น (คั่นด้วยเครื่องหมาย , )</label>
          <input type="text" class="form-control" id="fieldExclude" name="field_exclude"
            value="{{ field_exclude or '' }}">
        </div>

        <!-- ปุ่ม toggle auto assign field -->
        <button type="submit" name="toggle_auto_assign" class="btn btn-outline-primary mb-3">
          {% if auto_assign_field %}
          ปิดการกำหนดเลขสนามอัตโนมัติ
          {% else %}
          เปิดการกำหนดเลขสนามอัตโนมัติ
          {% endif %}
        </button>

        {% endif %}
        <table class="table table-bordered table-hover align-middle text-center mb-3">
          <thead class="table-light">
            <tr>
              <th>ทีม</th>
              <th>ทีม</th>
              <th>ผลการแข่งขัน</th>
              <th>สนาม</th>
            </tr>
          </thead>
          <tbody>
            {% for match in matches %}
            <tr>
              <td>{{ teams[match.team1_id] if match.team1_id else '-' }}</td>
              <td>{{ teams[match.team2_id] if match.team2_id else '-' }}</td>
              <td>
                {% if match.team1_id and (not match.team2_id or match.team2_id == 'BYE') %}
                <input type="number" name="score_{{ match.id }}_1" min="0" value="13" disabled
                  class="form-control d-inline-block text-center" style="width: 70px" />
                -
                <input type="number" name="score_{{ match.id }}_2" min="0" value="7" disabled
                  class="form-control d-inline-block text-center" style="width: 70px" />
                {% else %}
                <input type="number" name="score_{{ match.id }}_1" min="0"
                  value="{{ match.team1_score | int if match.team1_score is not none else '' }}"
                  class="form-control d-inline-block text-center" style="width: 70px" />
                -
                <input type="number" name="score_{{ match.id }}_2" min="0"
                  value="{{ match.team2_score | int if match.team2_score is not none else '' }}"
                  class="form-control d-inline-block text-center" style="width: 70px" />
                {% endif %}
              </td>
              <td>
                <input type="text" name="field_{{ match.id }}"
                  value="{% if auto_assign_field and match.field %}{{ match.field }}{% elif not auto_assign_field and match.field %}{{ match.field }}{% else %}{% endif %}"
                  class="form-control" {% if auto_assign_field %}readonly{% endif %}>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if current_user.is_authenticated and current_user.role in ['admin', 'superadmin'] %}
        <div class="d-flex justify-content-between flex-wrap gap-2 align-items-start mb-3">

          <!-- ปุ่มด้านซ้าย -->
          <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('score_sheet_all', event_id=event.id) }}?round={{ round }}" target="_blank"
              class="btn btn-outline-secondary">พิมพ์ใบบันทึกคะแนน</a>
            <button type="submit" name="action" value="lock_scores" class="btn btn-danger">บันทึก + ล็อกผล</button>
            <button type="submit" name="action" value="save_fields" class="btn btn-primary">บันทึกเลขสนาม</button>
            <button type="reset" class="btn btn-outline-warning">ล้างฟอร์ม</button>
            <input type="hidden" name="round" value="{{ selected_round }}">
          </div>

          

        </div>
        {% else %}
        <p>โหมดผู้เข้าชม: คุณกำลังดูข้อมูลการแข่งขัน</p>
        {% endif %}

      </form>

    </div>
  </div>

  <!-- STANDINGS -->
  <h4 class="mb-3">ตารางคะแนน</h4>
  {% if standings %}
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-bordered table-sm align-middle text-center mb-5">
      <thead class="table-light">
        <tr>
          <th>No.</th>
          <th>TEAM</th>
          {% for i in range(1, event.rounds + 1) %}
          <th>VS_Round{{ i }}</th>
          {% endfor %}
          <th>score</th>
          <th>BHN</th>
          <th>fBHN</th>
          <th>+-</th>
        </tr>
      </thead>
      <tbody>
        {% for team in standings %}
        <tr class="{{ macros.score_class(team.score) }}" style="font-weight: bold">
          <td>{{ loop.index }}</td>
          <td class="{{ macros.score_class(team.score) }}">{{ team.team_name }}</td>
          {% for i in range(1, event.rounds + 1) %}
          <td class="{{ macros.score_class(team.score) }}">
            {{ team["VS_Round" ~ i] if team["VS_Round" ~ i] else '-' }}
          </td>
          {% endfor %}
          <td class="{{ macros.score_class(team.score) }}">{{ team.score }}</td>
          <td class="{{ macros.score_class(team.score) }}">{{ team.buchholz }}</td>
          <td class="{{ macros.score_class(team.score) }}">{{ team.final_buchholz }}</td>
          <td class="{{ macros.score_class(team.score) }}">{{ team.point_diff }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
  </div>
  {% else %}
  <p class="text-muted fst-italic">No standings available.</p>
  {% endif %}

  

<!-- ปุ่มด้านขวา -->
          <form method="post" action="{{ url_for('pair_next_round', event_id=event.id) }}">
            <button type="submit" class="btn btn-info mb-4">จับคู่รอบถัดไป</button>
          </form>

  <!-- ปุ่มกลับ -->
  <div class="mb-4">
    <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-secondary me-2">← กลับรายการแข่งขัน</a>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">← กลับหน้าแรก</a>
  </div>
</div>
{% endblock %}

{% block footer %}
<footer class="text-center mt-4 mb-2">
  &copy; {{ current_year }} Swiss System For Petanque Sport. (By PASIN PHIMKUMLAI) Adviser by Dr.VINIT
  JARUPARNITKUL(M.D.)
</footer>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const autoAssignField = document.getElementById("autoAssignField");
    if (autoAssignField) {
      autoAssignField.addEventListener("change", function () {
        this.form.submit();
      });
    }
  });
</script>
{% endblock %}